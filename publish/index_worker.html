<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <link rel="icon" href="./res/loading/favicon.ico" type="image/x-icon" />

    <title>Wonder</title>
    <style>
        #stream-loading {
            display: none;
        }

        #stream-loading .loading-img {
            display: block;
            width: 250px;
            height: 250px;
        }

        #stream-loading .loading-text {
            color: #e7981f;
            margin-top: 10px;
            font-size: 85px;
            font-weight: bold;
        }




        #whole-loading {
            position: absolute;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background: #1d1b22;
        }

        #whole-loading .loading-content {
            width: 50%;
            height: 50%;
            text-align: center;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        #whole-loading .loading-content .loading-img {
            width: 250px;
            height: 250px;
        }

        #whole-loading .loading-content .loading-text {
            color: #e7981f;
            margin-top: 10px;
            font-size: 85px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1 id="detect" style="display: none">your browser not support sharedArrayBuffer or offscreenCanvas, can't use
        worker.</h1>

    <div id="stream-loading">
        <img id="logo" class="loading-img" src="./res/loading/logo.png" />
        <br />
        <span id="text" class="loading-text"></span>
    </div>


    <div id="whole-loading">
        <div class="loading-content">
            <div>
                <img id="logo" class="loading-img" src="./res/loading/logo.png" />
            </div>
            <div>
                <div id="text" class="loading-text"></div>
            </div>
        </div>
    </div>





    <script src="./wd.js"></script>
    <script src="./wd.render.worker.js"></script>

    <script>
        var AssetTool = (function () {
            function computeLoadingPercent(
                loadedIMGUIByteLength,
                totalByteLength
            ) {
                return loadedIMGUIByteLength >= totalByteLength ? 100 : Math.ceil(loadedIMGUIByteLength / totalByteLength * 100);
            }

            function getStreamLoadTextDom() {
                return document.querySelector("#stream-loading #text");
            }

            function getWholeLoadTextDom() {
                return document.querySelector("#whole-loading #text");
            }

            return {
                isSupportStreamLoad: function () {
                    return typeof window.ReadableStream !== "undefined";
                },
                showStreamLoading: function () {
                    var windowWidth = window.innerWidth;
                    var windowHeight = window.innerHeight;


                    document.querySelector("#stream-loading").style.display = "block";
                    document.querySelector("#whole-loading").style.display = "none";



                    var dom = document.querySelector("#stream-loading");

                    var totalWidth = 250;
                    var totalHeight = 360 - 10;

                    var top = (windowHeight - totalHeight) / 2;
                    var left = (windowWidth - totalWidth) / 2;


                    dom.style.cssText = 'display:block;position:absolute;top:' + top + 'px;left:' + left + 'px;color:bisque; text-align: center;';
                },
                showWholeLoading: function () {
                    document.querySelector("#stream-loading").style.display = "none";
                    document.querySelector("#whole-loading").style.display = "flex";
                },
                showOrCreateLoadingInfo: function (
                    loadedIMGUIByteLength,
                    totalByteLength,
                ) {
                    var loadingPercentStr = String(computeLoadingPercent(

                        loadedIMGUIByteLength,
                        totalByteLength
                    )) + '%';

                    getStreamLoadTextDom().innerHTML = loadingPercentStr;
                    getWholeLoadTextDom().innerHTML = loadingPercentStr;

                },
                removeLoadingInfo: function () {
                    document.querySelector("#stream-loading").remove();
                    document.querySelector("#whole-loading").remove();
                },
                loadConfig: function (jsonPathArr, nextFunc, completeFunc) {
                    return wd.loadConfig(jsonPathArr).forEach(function (state) {
                        if (!!nextFunc) {
                            nextFunc(state)
                        }
                    }).then(function () {
                        if (!!completeFunc) {
                            return completeFunc()
                        }
                    })
                },
                loadStreamWDB: function (wdbPath, handleWhenLoadingFunc, handleBeforeStartLoopFunc, handleWhenDoneFunc, handleWhenLoadWholeWDBFunc, state) {
                    return wd.loadStreamWDB(wdbPath, handleWhenLoadingFunc, handleBeforeStartLoopFunc, handleWhenDoneFunc, handleWhenLoadWholeWDBFunc, state).drain()
                }
            }
        })()


        function _extend(destination, source) {
            for (let property in source) {
                destination[property] = source[property];
            }
            return destination;
        }

        function _initScriptAPIJob(stateData) {
            function _getAssetBundlePath() {
                return "AssetBundles/";
            };

            function _initAssetBundleArrayBufferCache() {
                var databaseName = "Wonder_Database";
                var tableName = "Wonder_AssetBundle_Cache";
                var cacheFieldName = "Cache";
                var hashIdFieldName = "HashId";
                var abRelativePathFieldName = "ABRelativePath";

                if (!!window.db) {
                    console.log("already init before");

                    return new Promise((resolve) => {
                        resolve();
                    }, (reject) => {
                        reject("error");
                    })

                };

                var request = window.indexedDB.open(databaseName);

                return new Promise((resolve, reject) => {
                    request.onerror = (event) => {
                        reject("open database error: ", event.target.errorCode);
                    };

                    request.onsuccess = (event) => {
                        var db = event.target.result;

                        console.log("open onsuccess");

                        window.db = db;

                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        var db = event.target.result;

                        console.log("open onupgradeneeded");

                        if (!db.objectStoreNames.contains(tableName)) {
                            var objectStore = db.createObjectStore(
                                tableName,
                                {
                                    keyPath: abRelativePathFieldName,
                                    autoIncrement: false
                                }
                            );

                            // objectStore.createIndex(cacheFieldName, cacheFieldName, { unique: false });
                            // objectStore.createIndex(hashIdFieldName, hashIdFieldName, { unique: true });
                            // objectStore.createIndex(abRelativePathFieldName, abRelativePathFieldName, { unique: true });
                        }
                        else {
                            reject("database->table error: shouldn't exist table: ", tableName);
                        }
                    };
                })
            };


            function _isAssetBundleArrayBufferCached(abRelativePath, hashId) {
                var databaseName = "Wonder_Database";
                var tableName = "Wonder_AssetBundle_Cache";
                var cacheFieldName = "Cache";
                var hashIdFieldName = "HashId";
                var abRelativePathFieldName = "ABRelativePath";

                var transaction = window.db.transaction([tableName]);
                var objectStore = transaction.objectStore(tableName);
                // var abRelativePath = objectStore.index(abRelativePathFieldName);
                var request = objectStore.get(abRelativePath);



                return new Promise((resolve, reject) => {
                    request.onerror = (event) => {
                        reject("error: ", event.target.errorCode);
                    };

                    request.onsuccess = (event) => {
                        if (request.result) {

                            console.log("is cached: ", abRelativePath, request.result[hashIdFieldName] === hashId);

                            resolve(request.result[hashIdFieldName] === hashId);
                        } else {
                            console.log("get no data");

                            resolve(false);
                        }
                    };
                })

            };


            function _getAssetBundleArrayBufferCache(abRelativePath) {
                var databaseName = "Wonder_Database";
                var tableName = "Wonder_AssetBundle_Cache";
                var cacheFieldName = "Cache";
                var hashIdFieldName = "HashId";
                var abRelativePathFieldName = "ABRelativePath";

                var transaction = window.db.transaction([tableName]);
                var objectStore = transaction.objectStore(tableName);
                // var abRelativePath = objectStore.index(abRelativePathFieldName);
                // var request = abRelativePath.get(abRelativePath);
                // var abRelativePath = objectStore.index(abRelativePathFieldName);
                var request = objectStore.get(abRelativePath);



                return new Promise((resolve, reject) => {
                    request.onerror = (event) => {
                        reject("error: ", event.target.errorCode);
                    };

                    request.onsuccess = (event) => {
                        if (request.result) {

                            console.log("get cached data:", abRelativePath, request.result[cacheFieldName]);

                            resolve(request.result[cacheFieldName]);
                        } else {
                            reject("get no cache")
                        }
                    };
                })
            };


            function _cacheAssetBundleArrayBuffer(abRelativePath, ab, hashId) {
                var databaseName = "Wonder_Database";
                var tableName = "Wonder_AssetBundle_Cache";
                var cacheFieldName = "Cache";
                var hashIdFieldName = "HashId";
                var abRelativePathFieldName = "ABRelativePath";

                var transaction = window.db.transaction([tableName], "readwrite");
                var objectStore = transaction.objectStore(tableName);
                // var abRelativePath = objectStore.index(abRelativePathFieldName);
                // var request = abRelativePath.get(abRelativePath);
                // var request = objectStore.get(abRelativePath);
                var data = {};
                data[abRelativePathFieldName] = abRelativePath;
                data[cacheFieldName] = ab;
                data[hashIdFieldName] = hashId;

                var request =
                    objectStore.put(
                        data
                    );


                return new Promise((resolve, reject) => {
                    request.onerror = (event) => {
                        reject("cache fail: ", event.target.errorCode);
                    };

                    request.onsuccess = (event) => {
                        console.log("cache success: ", abRelativePath);

                        resolve();
                    };
                })
            };

            var state = wd.getStateFromData(stateData);

            var state = wd.setScriptAPIJsObj(
                _extend(
                    wd.getScriptAPIJsObj(state),
                    {
                        "getAssetBundlePath": _getAssetBundlePath,
                        "initAssetBundleArrayBufferCache": _initAssetBundleArrayBufferCache,
                        "isAssetBundleArrayBufferCached": _isAssetBundleArrayBufferCached,
                        "getAssetBundleArrayBufferCache": _getAssetBundleArrayBufferCache,
                        "cacheAssetBundleArrayBuffer": _cacheAssetBundleArrayBuffer,
                    }
                ),
                state
            );

            wd.setState(state);
        }

        function _addJobs(state) {
            var state = wd.addWorkerMainInitJob(["init_script_api", "init_script"], 0, _initScriptAPIJob, state);

            return state;
        }

        window.onload = function () {
            if (wd.isSupportRenderWorkerAndSharedArrayBuffer() === false) {
                document.querySelector("#detect").style.display = "block";

                return;
            }
            else {
                document.querySelector("#detect").style.display = "none";
            }


            if (
                AssetTool.isSupportStreamLoad()
            ) {
                AssetTool.showStreamLoading();
            }
            else {
                AssetTool.showWholeLoading();
            }

            return AssetTool.loadConfig(["./config/setting.json", "./config/"], null, function () {
                var state = wd.unsafeGetState();

                var state = _addJobs(state);

                return AssetTool.loadStreamWDB("./Scene.wdb",
                    function (totalLoadedByteLength, contentLength, wdbPath) {
                        AssetTool.showOrCreateLoadingInfo(
                            totalLoadedByteLength,
                            contentLength
                        );
                    },
                    function (state, gameObject) {
                        return state;
                    },
                    function (state, gameObject) {
                        AssetTool.removeLoadingInfo();

                        var state = wd.addSceneChild(gameObject, state);

                        return state;
                    },
                    function (state, _, gameObject) {
                        AssetTool.removeLoadingInfo();

                        var state = wd.addSceneChild(gameObject, state);

                        wd.startDirector(state);
                    }, state);
            });
        }
    </script>
</body>

</html>