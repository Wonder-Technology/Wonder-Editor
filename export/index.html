<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <link rel="icon" href="./res/loading/favicon.ico" type="image/x-icon" />

    <title>Wonder</title>
    <style>
        #loading {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #1d1b22;
        }

        #loading .loading-content {
            width: 50%;
            height: 50%;
            text-align: center;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        #loading .loading-content .loading-img {
            width: 250px;
            height: 250px;
        }

        #loading .loading-content .loading-text {
            color: #e7981f;
            margin-top: 10px;
            font-size: 85px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1 id="detect" style="display: none">your browser not support sharedArrayBuffer or offscreenCanvas, can't use
        worker. please use no worker!</h1>

    <!-- <div id="loading">
        <img id="logo" style="display: none;" src="./res/loading/logo.png" width=100 height=100 />
        <br />
        <span id="text"></span>
    </div> -->


    <div id="loading">
        <div class="loading-content">
            <div>
                <img id="logo" class="loading-img" src="./res/loading/logo.png" />
            </div>
            <div>
                <div id="text" class="loading-text"></div>
            </div>
        </div>
    </div>



    <script src="./wd.min.js"></script>

    <script>
        var AssetTool = (function () {
            function computeLoadingPercent(
                loadedIMGUIByteLength,
                totalByteLength
            ) {
                return loadedIMGUIByteLength >= totalByteLength ? 100 : Math.ceil(loadedIMGUIByteLength / totalByteLength * 100);
            }

            return {
                showOrCreateLoadingInfo: function (
                    loadedIMGUIByteLength,
                    totalByteLength,
                ) {
                    var windowWidth = window.innerWidth;
                    var windowHeight = window.innerHeight;


                    // document.querySelector("#logo").style.display = "inline";

                    // var dom = document.querySelector("#loading");


                    // dom.style.cssText = 'position:absolute;top:' + windowHeight * 0.55 + 'px;left:' + windowWidth * 0.4 + 'px;width:' + windowWidth * (0.6 - 0.4) + 'px;height:50px;font-size:80px; color:bisque; text-align: center;';




                    document.querySelector("#text")
                        .innerHTML = String(computeLoadingPercent(

                            loadedIMGUIByteLength,
                            totalByteLength
                        )) + '%';
                },
                removeLoadingInfo: function () {
                    document.querySelector("#loading").remove();
                },
                loadConfig: function (jsonPathArr, nextFunc, completeFunc) {
                    return wd.loadConfig(jsonPathArr).forEach(function (state) {
                        if (!!nextFunc) {
                            nextFunc(state)
                        }
                    }).then(function () {
                        if (!!completeFunc) {
                            return completeFunc()
                        }
                    })
                },
                loadStreamWDB: function (wdbPath, handleWhenLoadingFunc, handleBeforeStartLoopFunc, handleWhenDoneFunc, handleWhenLoadWholeWDBFunc, state) {
                    return wd.loadStreamWDB(wdbPath, handleWhenLoadingFunc, handleBeforeStartLoopFunc, handleWhenDoneFunc, handleWhenLoadWholeWDBFunc, state).drain()
                },
                loadIMGUIAsset: function (fntFilePath, bitmapFilePath, customTextureSourceDataArr, handleWhenLoadingFunc, handleWhenDoneFunc, state) {
                    return wd.loadIMGUIAsset(
                        fntFilePath,
                        bitmapFilePath,
                        customTextureSourceDataArr,
                        handleWhenLoadingFunc,
                        state)
                        .then((state) => {
                            return handleWhenDoneFunc(state)
                        })
                }
            }
        })()


        window.onload = function () {
            /*
            if (wd.isSupportRenderWorkerAndSharedArrayBuffer() === false) {
                document.querySelector("#detect").style.display = "block";

                return;
            }
            else {
                document.querySelector("#detect").style.display = "none";
            }
            */


            var loadedIMGUIByteLength = 0;

            var totalIMGUIByteLength = (35 + 41 + 95) * 1024;
            var totalWDBByteLength = 1.28 * 1024 * 1024;
            // var totalWDBByteLength = $totalWDBByteLength;
            var totalByteLength = totalIMGUIByteLength + totalWDBByteLength;

            return AssetTool.loadConfig(["./config/setting.json", "./config/"], null, function () {
                return AssetTool.loadIMGUIAsset(
                    "./res/loading/Lato-Regular-64.fnt",
                    "./res/loading/lato.png",
                    [
                    ],

                    function (contentLength, filePath) {
                        loadedIMGUIByteLength += contentLength;

                        AssetTool.showOrCreateLoadingInfo(
                            loadedIMGUIByteLength,
                            totalByteLength
                        );
                    },
                    function (state) {
                        return AssetTool.loadStreamWDB("./Scene.wdb",
                            function (totalLoadedByteLength, contentLength, wdbPath) {
                                AssetTool.showOrCreateLoadingInfo(
                                    loadedIMGUIByteLength + totalLoadedByteLength,
                                    totalByteLength
                                );
                            },
                            function (state, gameObject) {
                                return state;
                            },
                            function (state, gameObject) {
                                AssetTool.removeLoadingInfo();

                                return state;
                            },
                            function (state, _, gameObject) {
                                AssetTool.removeLoadingInfo();

                                wd.startDirector(state);
                            }, state);
                    }, wd.unsafeGetState());
            });
        }
    </script>
</body>

</html>